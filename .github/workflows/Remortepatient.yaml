name: CI - Playwright Automation (Scheduled + Manual)

on:
  # ðŸ‘‡ Allows you to trigger the workflow manually for testing
  workflow_dispatch: {}

  # ðŸ‘‡ These will only auto-trigger after merging to main
  schedule:
    # âœ… Every day at 7 PM IST (1:30 PM UTC) â†’ Sanity
    - cron: "30 13 * * *"
    # âœ… Every Friday at 6 PM IST (12:30 PM UTC) â†’ Regression
    - cron: "30 12 * * 5"

jobs:
  # -----------------------
  # Daily Sanity Job
  # -----------------------
  sanity-job:
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '30 13 * * *') ||
      (github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    env:
      APP_USERNAME: ${{ secrets.APP_USERNAME }}
      APP_PASSWORD: ${{ secrets.APP_PASSWORD }}
    steps:
      - name: Checkout rpm-preprod Branch
        uses: actions/checkout@v4
        with:
          ref: rpm-preprod

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pytest pytest-html playwright openpyxl
          playwright install --with-deps chromium

      - name: Run Sanity Tests
        run: |
          pytest -v tests/ \
            --html=report.html \
            --self-contained-html \
            --maxfail=1 \
            --disable-warnings \
            -m sanity

      - name: Upload HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-sanity-report
          path: report.html

  # -----------------------
  # Friday Regression Job
  # -----------------------
  regression-job:
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '30 12 * * 5') ||
      (github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    env:
      APP_USERNAME: ${{ secrets.APP_USERNAME }}
      APP_PASSWORD: ${{ secrets.APP_PASSWORD }}
    steps:
      - name: Checkout rpm-preprod Branch
        uses: actions/checkout@v4
        with:
          ref: rpm-preprod

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pytest pytest-html playwright openpyxl
          playwright install --with-deps chromium

      - name: Run Regression Tests
        run: |
          pytest -v tests/ \
            --html=report.html \
            --self-contained-html \
            --maxfail=1 \
            --disable-warnings \
            -m regression

      - name: Upload HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-regression-report
          path: report.html
